{
	"name": "data_lake_sql_serverless_taxi_demo",
	"properties": {
		"content": {
			"query": "--------------------\n-- Create Data Source\n-------------------\n\nIF NOT EXISTS (SELECT * FROM sys.external_data_sources WHERE name = 'demo_adls') \n\tCREATE EXTERNAL DATA SOURCE [demo_adls] \n\tWITH (\n\t\tLOCATION   = 'https://dvtrainingadls.dfs.core.windows.net/demo'\n\t)\nGo\n\n--------------------------------------\n-- Simple query without external table (3s)\n--------------------------------------\nSELECT TOP 10 *\nFROM OPENROWSET(BULK 'nyc_taxi/yellow_trips_detail/year_month=2018_01/*.snappy.parquet',\n                DATA_SOURCE = 'demo_adls',\n      \t\t\tFORMAT='PARQUET') AS nyc\nWHERE VendorID = 2\n\n\n-------------------------\n-- Parquet external table\n-------------------------\nIF EXISTS (SELECT * FROM sys.external_tables WHERE name = 'yellow_trips_detail') \n\tDROP EXTERNAL TABLE yellow_trips_detail\n\nIF NOT EXISTS (SELECT * FROM sys.external_file_formats WHERE name = 'Parquet') \n\tCREATE EXTERNAL FILE FORMAT Parquet WITH (  FORMAT_TYPE = PARQUET )\n\nCREATE EXTERNAL TABLE yellow_trips_detail (\n\t[VendorID] int,\n\t[tpep_pickup_datetime] datetime2(7),\n\t[tpep_dropoff_datetime] datetime2(7),\n\t[passenger_count] int,\n\t[trip_distance] float,\n\t[RatecodeID] int,\n\t[store_and_fwd_flag] varchar(8000),\n\t[PULocationID] int,\n\t[DOLocationID] int,\n\t[payment_type] int,\n\t[fare_amount] float,\n\t[extra] float,\n\t[mta_tax] float,\n\t[tip_amount] float,\n\t[tolls_amount] float,\n\t[improvement_surcharge] float,\n\t[total_amount] float,\n\t[pickup_dt] datetime2(7),\n\t[dropoff_dt] datetime2(7)\n\t)\n\tWITH (\n\tLOCATION = 'nyc_taxi/yellow_trips_detail/year_month=2018_01/part-*.snappy.parquet',\n\tDATA_SOURCE = [demo_adls],\n\tFILE_FORMAT = [Parquet]\n\t)\nGO\n\n-- Sample top 10 (3s)\nSELECT TOP 10 * FROM yellow_trips_detail\n\n\n-- Aggregate and filter to a single day (20s)\nSELECT VendorId, cast(Tpep_pickup_datetime as date) as PickupDate, Sum(Trip_distance) as TotalTripDistance\nFROM yellow_trips_detail\nwhere cast(Tpep_pickup_datetime as date) = '2018-01-01'\nGROUP BY VendorId, cast(Tpep_pickup_datetime as date)\n\n\n--------------------\n-- Create External Table As (7s)\n-- NOTE: Before running, clear out Location using Azure Portal\n-------------------\nIF EXISTS (SELECT * FROM sys.external_tables WHERE name = 'ext_trips_daily') \n\tDROP EXTERNAL TABLE ext_trips_daily\n\nCREATE EXTERNAL TABLE ext_trips_daily\nWITH ( \n    LOCATION = 'nyc_taxi/ext_trips_daily',\n\tDATA_SOURCE = [demo_adls],\n\tFILE_FORMAT = [Parquet]\n)\nAS\nSELECT VendorId, cast(Tpep_pickup_datetime as date) as PickupDate, Sum(Trip_distance) as TotalTripDistance\nFROM yellow_trips_detail\nGROUP BY VendorId, cast(Tpep_pickup_datetime as date)\nGO\n\n-- Filter external table to a single day (2s)\nSELECT * from ext_trips_daily where PickupDate = '2018-01-01'\n\n\n-----------------\n-- Create View\n-----------------\nCREATE OR ALTER VIEW vw_trips_daily AS\nSELECT VendorId, cast(Tpep_pickup_datetime as date) as PickupDate, Sum(Trip_distance) as TotalTripDistance\nFROM OPENROWSET(BULK 'nyc_taxi/yellow_trips_detail/year_month=2018_01/*.snappy.parquet',\n                DATA_SOURCE = 'demo_adls',\n      \t\t\tFORMAT='PARQUET') AS nyc\nGROUP BY VendorId, cast(Tpep_pickup_datetime as date)\nGO\n\n-- Filter view to a single day (6s)\nSELECT * from vw_trips_daily where PickupDate = '2018-01-01'\n\n\n-- --------------------\n-- -- CSV external table\n-- -------------------\n\n-- IF NOT EXISTS (SELECT * FROM sys.external_file_formats WHERE name = 'Csv') \n-- \tCREATE EXTERNAL FILE FORMAT Csv WITH (  \n-- \t\tFORMAT_TYPE = DELIMITEDTEXT,\n--     \tFORMAT_OPTIONS ( FIELD_TERMINATOR = ',', STRING_DELIMITER = '\"', FIRST_ROW = 2   ))\n-- GO\n\n-- IF EXISTS (SELECT * FROM sys.external_tables WHERE name = 'trips_external_csv') \n-- \tDROP EXTERNAL TABLE trips_external_csv\n-- Go\n\n\n-- CREATE EXTERNAL TABLE trips_external_csv\n-- (\n-- VendorID int,\n-- tpep_pickup_datetime varchar,\n-- tpep_dropoff_datetime varchar,\n-- passenger_count int,\n-- trip_distance float,\n-- RatecodeID int,\n-- store_and_fwd_flag varchar,\n-- PULocationID int,\n-- DOLocationID int,\n-- payment_type int,\n-- fare_amount float,\n-- extra float,\n-- mta_tax float,\n-- tip_amount int,\n-- tolls_amount int,\n-- improvement_surcharge float,\n-- total_amount float,\n-- congestion_surcharge varchar\n-- )\n-- WITH (\n-- \tLOCATION = 'nyctaxi/tripdata/yellow/2019/yellow_tripdata_2019-01.csv.gz',\n-- \tDATA_SOURCE = [demo_adls],\n-- \tFILE_FORMAT = [Csv]\n-- \t)\n-- GO\n\n\n-- SELECT TOP 10 * FROM trips_external_csv\n-- GO\n",
			"metadata": {
				"language": "sql"
			},
			"currentConnection": {
				"name": "demo",
				"type": "SqlOnDemand"
			}
		},
		"type": "SqlQuery"
	}
}